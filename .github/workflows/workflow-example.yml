name: Test ECS Runner

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-runner:
    name: Test on ECS Runner.
    runs-on: [self-hosted, Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print runner info
        run: |
          echo "Runner: ${{ runner.name }}"
          echo "OS: ${{ runner.os }}"
          echo "Architecture: ${{ runner.arch }}"
          echo "Working directory: ${{ runner.workspace }}"

      - name: Test Node.js
        run: |
          node --version
          npm --version

      - name: Test Python
        run: |
          python3 --version
          pip3 --version

      - name: Test Java
        run: |
          java -version
          mvn --version

  build-docker-image:
    name: Build Docker Image
    runs-on: [self-hosted, Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image with Kaniko
        run: |
          WORKSPACE_DIR="$(pwd)"
          IMAGE_NAME="test-hello-world"
          IMAGE_TAG="${{ github.sha }}"
          OCI_LAYOUT_DIR="${WORKSPACE_DIR}/.oci-layout"

          # Verify Dockerfile exists
          echo "=== Verifying Dockerfile location ==="
          echo "Current directory: ${WORKSPACE_DIR}"
          echo "Dockerfile path: ${WORKSPACE_DIR}/Dockerfile"
          ls -la Dockerfile || (echo "ERROR: Dockerfile not found!" && exit 1)
          echo "✓ Dockerfile found"

          echo ""
          echo "=== Building image with Kaniko ==="

          # Use cache directory in workspace
          CACHE_DIR="${WORKSPACE_DIR}/.kaniko-cache"
          mkdir -p ${CACHE_DIR}
          mkdir -p ${OCI_LAYOUT_DIR}

          # Build to OCI layout format (no push, no tar)
          /kaniko/executor \
            --context ${WORKSPACE_DIR} \
            --dockerfile ${WORKSPACE_DIR}/Dockerfile \
            --oci-layout-path ${OCI_LAYOUT_DIR} \
            --cache-dir ${CACHE_DIR} \
            --no-push

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "OCI_LAYOUT_DIR=${OCI_LAYOUT_DIR}" >> $GITHUB_ENV

          echo "✓ Image built successfully!"

      - name: Show image information
        run: |
          echo "=== Docker Images (Built) ==="
          echo ""

          # Get image information from OCI layout
          if [ -f "${OCI_LAYOUT_DIR}/index.json" ]; then
            # Extract image digest (first 12 chars like docker)
            FULL_DIGEST=$(jq -r '.manifests[0].digest' ${OCI_LAYOUT_DIR}/index.json 2>/dev/null)
            IMAGE_ID=$(echo ${FULL_DIGEST} | cut -d':' -f2 | cut -c1-12)
            
            # Get image size
            IMAGE_SIZE=$(du -sh ${OCI_LAYOUT_DIR} 2>/dev/null | awk '{print $1}')
            
            # Get creation time
            CREATED_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")
            
            # Display in docker images format
            printf "REPOSITORY          TAG                 IMAGE ID       CREATED              SIZE\n"
            printf "%-20s %-20s %-15s %-20s %s\n" "${IMAGE_NAME}" "${IMAGE_TAG}" "${IMAGE_ID:-N/A}" "${CREATED_TIME}" "${IMAGE_SIZE:-N/A}"
            printf "%-20s %-20s %-15s %-20s %s\n" "${IMAGE_NAME}" "latest" "${IMAGE_ID:-N/A}" "${CREATED_TIME}" "${IMAGE_SIZE:-N/A}"
          else
            echo "Error: Could not find OCI layout index.json"
            ls -la ${OCI_LAYOUT_DIR} || true
            exit 1
          fi

          echo ""
          echo "=== Image Details ==="
          echo "Repository: ${IMAGE_NAME}"
          echo "Tag: ${IMAGE_TAG}"
          echo "Image ID: ${IMAGE_ID}"
          echo "Size: ${IMAGE_SIZE}"
          echo "Location: ${OCI_LAYOUT_DIR}"
          echo ""
          echo "Note: Image is built in OCI layout format (not pushed to registry)"

      - name: Cleanup
        if: always()
        run: |
          WORKSPACE_DIR="$(pwd)"
          rm -rf ${WORKSPACE_DIR}/.kaniko-cache || true
          rm -rf ${WORKSPACE_DIR}/.oci-layout || true
          echo "✓ Cleanup complete - kaniko cache and OCI layout deleted"

  simple-build:
    name: Simple Build Test
    runs-on: [Linux, X64, cs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."

      - name: Run tests
        run: |
          echo "Running tests..."

      - name: Build artifact
        run: |
          echo "Building artifact..."
