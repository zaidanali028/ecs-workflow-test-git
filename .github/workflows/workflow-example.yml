name: Test ECS Runner

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-runner:
    name: Test on ECS Runner.
    runs-on: [self-hosted, Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print runner info
        run: |
          echo "Runner: ${{ runner.name }}"
          echo "OS: ${{ runner.os }}"
          echo "Architecture: ${{ runner.arch }}"
          echo "Working directory: ${{ runner.workspace }}"

      - name: Test Node.js
        run: |
          node --version
          npm --version

      - name: Test Python
        run: |
          python3 --version
          pip3 --version

      - name: Test Java
        run: |
          java -version
          mvn --version

  build-docker-image:
    name: Build Docker Image
    runs-on: [self-hosted, Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image with Kaniko
        run: |
          IMAGE_NAME="test-hello-world:${{ github.sha }}"
          WORKSPACE_DIR="$(pwd)"
          TAR_PATH="${WORKSPACE_DIR}/${IMAGE_NAME//:/_}.tar"
          # Use home directory for kaniko - user has full ownership
          KANIKO_DIR="${HOME}/.kaniko"
          # Verify Dockerfile exists
          echo "=== Verifying Dockerfile location ==="
          echo "Current directory: ${WORKSPACE_DIR}"
          echo "Dockerfile path: ${WORKSPACE_DIR}/Dockerfile"
          ls -la Dockerfile || (echo "ERROR: Dockerfile not found!" && exit 1)
          echo "✓ Dockerfile found"
          echo ""
          echo "=== Building image with Kaniko ==="

          # Find Kaniko executor (check both /kaniko/executor and PATH)
          if [ -f "/kaniko/executor" ]; then
            KANIKO_EXEC="/kaniko/executor"
            echo "✓ Kaniko found at /kaniko/executor"
          else
            echo "ERROR: Kaniko executor not found"
            echo "Checking locations..."
            ls -la /kaniko/ 2>/dev/null || echo "/kaniko directory not found"
            which executor || echo "Kaniko not in PATH"
            echo ""
            echo "The runner image may need to be restarted to use the new image."
            echo "Wait a few minutes for ECS service to deploy new tasks."
            exit 1
          fi

          # Create custom kaniko directory in workspace (user owns it)
          KANIKO_WORK_DIR="${WORKSPACE_DIR}/.kaniko-work"
          mkdir -p ${KANIKO_WORK_DIR}
          echo "Using kaniko work directory: ${KANIKO_WORK_DIR}"

          # Check /kaniko permissions at runtime
          if [ -d "/kaniko" ]; then
            echo "=== Checking /kaniko permissions ==="
            ls -ld /kaniko
            echo "Current user: $(whoami)"
            echo "Current user ID: $(id -u)"
            echo "Can write to /kaniko? $(touch /kaniko/.test-write 2>/dev/null && echo 'yes' && rm -f /kaniko/.test-write || echo 'no - permission denied')"
            echo "Can create directory in /kaniko? $(mkdir -p /kaniko/.test-dir 2>/dev/null && echo 'yes' && rmdir /kaniko/.test-dir 2>/dev/null || echo 'no')"
            echo ""
          fi

          # Use cache directory in workspace
          CACHE_DIR="${WORKSPACE_DIR}/.kaniko-cache"
          mkdir -p ${CACHE_DIR}

          # Set KANIKO_DIR environment variable (Kaniko should respect this)
          export KANIKO_DIR=${KANIKO_WORK_DIR}
          echo "KANIKO_DIR environment variable: ${KANIKO_DIR}"

          # Build with Kaniko
          # Note: Even with custom kaniko-dir, Kaniko might still access /kaniko for the executor binary
          # The --force flag helps but may not solve all permission issues
          ${KANIKO_EXEC} \
            --context ${WORKSPACE_DIR} \
            --dockerfile ${WORKSPACE_DIR}/Dockerfile \
            --kaniko-dir ${KANIKO_WORK_DIR} \
            --tar-path ${TAR_PATH} \
            --cache-dir ${CACHE_DIR} \
            --force \
            --no-push
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "TAR_PATH=${TAR_PATH}" >> $GITHUB_ENV
          echo "✓ Image built successfully!"
          echo "Image saved to: ${TAR_PATH}"
      - name: Print image info
        run: |
          echo "=== Image Build Information ==="
          echo "Image Name: ${IMAGE_NAME}"
          echo "Tar Path: ${TAR_PATH}"
          echo ""
          echo "=== Image File Size ==="
          ls -lh ${TAR_PATH} || echo "Tar file not found"
          echo ""
          echo "=== Dockerfile Content ==="
          cat Dockerfile
          echo ""
          echo "=== Kaniko Build Complete ==="
          echo "Note: Image is saved as tar file. To use it, load with: docker load < ${TAR_PATH}"

      - name: Cleanup
        if: always()
        run: |
          WORKSPACE_DIR="$(pwd)"
          rm -f ${TAR_PATH} || true
          rm -rf ${WORKSPACE_DIR}/.kaniko-cache || true
          rm -rf ${WORKSPACE_DIR}/.kaniko-work || true
          echo "✓ Cleanup complete - image tar, kaniko cache and work dir deleted"

  simple-build:
    name: Simple Build Test
    runs-on: [self-hosted, Linux, X64, ecs]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."

      - name: Run tests
        run: |
          echo "Running tests..."

      - name: Build artifact
        run: |
          echo "Building artifact..."
