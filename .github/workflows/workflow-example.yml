name: Test ECS Runner

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-runner:
    name: Test on ECS Runner.
    runs-on: [self-hosted, Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print runner info
        run: |
          echo "Runner: ${{ runner.name }}"
          echo "OS: ${{ runner.os }}"
          echo "Architecture: ${{ runner.arch }}"
          echo "Working directory: ${{ runner.workspace }}"

      - name: Test Node.js
        run: |
          node --version
          npm --version

      - name: Test Python
        run: |
          python3 --version
          pip3 --version

      - name: Test Java
        run: |
          java -version
          mvn --version

  build-docker-image:
    name: Build Docker Image
    runs-on: [self-hosted, Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image with Kaniko
        run: |
          IMAGE_NAME="test-hello-world:${{ github.sha }}"
          WORKSPACE_DIR="$(pwd)"
          TAR_PATH="${WORKSPACE_DIR}/${IMAGE_NAME//:/_}.tar"
          # Use home directory for kaniko - user has full ownership
          KANIKO_DIR="${HOME}/.kaniko"
          # Verify Dockerfile exists
          echo "=== Verifying Dockerfile location ==="
          echo "Current directory: ${WORKSPACE_DIR}"
          echo "Dockerfile path: ${WORKSPACE_DIR}/Dockerfile"
          ls -la Dockerfile || (echo "ERROR: Dockerfile not found!" && exit 1)
          echo "✓ Dockerfile found"
          echo ""
          echo "=== Building image with Kaniko ==="
          # Create kaniko directory in user's home (user owns it)
          mkdir -p ${KANIKO_DIR}
          echo "Kaniko directory: ${KANIKO_DIR}"
          
          # Use cache directory in workspace
          CACHE_DIR="${WORKSPACE_DIR}/.kaniko-cache"
          mkdir -p ${CACHE_DIR}
          
          # Build with Kaniko using custom kaniko-dir and force flag
          /kaniko/executor \
            --context ${WORKSPACE_DIR} \
            --dockerfile ${WORKSPACE_DIR}/Dockerfile \
            --kaniko-dir ${KANIKO_DIR} \
            --tar-path ${TAR_PATH} \
            --cache-dir ${CACHE_DIR} \
            --force \
            --no-push
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "TAR_PATH=${TAR_PATH}" >> $GITHUB_ENV
          echo "✓ Image built successfully!"
          echo "Image saved to: ${TAR_PATH}"
          
      - name: Show image info
        run: |
          echo "=== Image Information ==="
          echo "Image: ${IMAGE_NAME}"
          echo "Tar file: ${TAR_PATH}"
          echo ""
          echo "=== Tar File Details ==="
          ls -lh ${TAR_PATH} || echo "Tar file not found"
          echo ""
          echo "Note: Image is saved as tar file. To use it:"
          echo "  docker load < ${TAR_PATH}"
          
      - name: Cleanup
        if: always()
        run: |
          WORKSPACE_DIR="$(pwd)"
          rm -f ${TAR_PATH} || true
          rm -rf ${HOME}/.kaniko || true
          rm -rf ${WORKSPACE_DIR}/.kaniko-cache || true
          echo "✓ Cleanup complete"


  simple-build:
    name: Simple Build Test
    runs-on: [Linux, X64, ecs]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."

      - name: Run tests
        run: |
          echo "Running tests..."

      - name: Build artifact
        run: |
          echo "Building artifact..."
